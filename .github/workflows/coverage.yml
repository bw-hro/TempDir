name: Code Coverage

permissions:
  pull-requests: write
  contents: write

on:
  pull_request:

jobs:
  coverage_report:
    name: Generate coverage report
    runs-on: ubuntu-latest
    steps:

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Setup vcpkg
      run: |
        python ./tools/install-vcpkg.py
        
    - name: Setup lcov
      uses: hrishikesh-kadam/setup-lcov@v1

    - name: Generate lcov input
      run: |
        chmod +x ./build.sh
        chmod +x ./coverage.sh
        ./coverage.sh

    - name: Report code coverage
      uses: zgosalvez/github-actions-report-lcov@v3
      with:
        coverage-files: build/filtered_coverage.info
        minimum-coverage: 90
        artifact-name: code-coverage-report
        github-token: ${{ secrets.GITHUB_TOKEN }}
        #working-directory: build/coverage_report
        update-comment: true

    - name: Upload code coverage report ðŸš€
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        folder: build/coverage_report
        target-folder: coverage-report
        branch: gh-pages

